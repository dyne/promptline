{"id":"batchat-278","title":"Add config env override and missing-key tests","description":"Add unit tests to internal/config for env precedence and validation. Cover: OPENAI_API_KEY/DASHSCOPE_API_KEY override file values; missing API key returns an error; provider defaults (model/base_url) are set when omitted. Update LoadConfig to fail fast on missing key if needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T13:03:05.054461925+01:00","updated_at":"2025-12-10T13:10:46.241992798+01:00","closed_at":"2025-12-10T13:10:46.241992798+01:00"}
{"id":"batchat-2ey","title":"Enhance CLI input handling to support command history and proper EOF handling","description":"","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-09T14:27:55.456726657+01:00","updated_at":"2025-12-09T14:35:41.004016332+01:00","closed_at":"2025-12-09T14:35:41.004016332+01:00"}
{"id":"batchat-2qt","title":"Command history not reloaded on startup","description":"Starting the TUI shows empty history navigation even when .promptline_history exists from prior runs; Ctrl+↑/↓ can’t recall past commands. History loader uses a fixed relative path and populates only an in-memory slice (cmd/promptline/main.go:86-195) instead of the readline history file/path used by session.RL. Align history loading/saving with the actual history file location and ensure prior commands are available immediately at boot.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-10T15:30:45.249886992+01:00","updated_at":"2025-12-12T12:10:41.591759497+01:00","closed_at":"2025-12-12T12:10:41.591759497+01:00"}
{"id":"batchat-3im","title":"Lock down tool execution and require user approval","description":"Tool registry currently exposes execute_shell_command/read_file/write_file plus an unconditional 'MUST use tools' system prompt, so model output can run arbitrary shell/file ops without user consent (internal/tools/tools.go:65-86, internal/tools/builtin.go:14-105, internal/chat/session.go:54-74). Add a permission layer or explicit allowlist with per-tool confirmation toggles, disable dangerous tools by default, and surface consent prompts in the UI before executing anything. Default allowlist should only include read-only tools (e.g., get_current_datetime, read_file, ls) with all execution/writes blocked unless explicitly enabled. Update the system prompt to match the new contract, add tests for blocked/allowed execution, and document the safety switches. Follow-up after tool-calling refactor: ensure the consent UI/docs reflect the new structured tool-call flow.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-10T11:57:47.797323878+01:00","updated_at":"2025-12-10T14:17:33.358237066+01:00","closed_at":"2025-12-10T14:17:33.358237066+01:00"}
{"id":"batchat-3vx","title":"Ctrl+Q quit modal freezes the TUI","description":"Pressing Ctrl+Q shows the quit modal but the UI becomes unresponsive: keypresses don’t dismiss the modal or return to chat, leaving the TUI frozen until force-quit. The quit prompt is built in showModalPromptAsync and invoked from input capture (cmd/promptline/main.go:291-699); focus never moves to the modal and app.Stop isn’t reachable. Fix the quit confirmation so Ctrl+Q cleanly shows a responsive modal and returns focus when cancelled.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T15:30:11.251737886+01:00","updated_at":"2025-12-10T16:26:45.811707695+01:00","closed_at":"2025-12-10T16:26:45.811707695+01:00"}
{"id":"batchat-3x8","title":"Convert promptline from tview TUI to streaming console architecture","description":"","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-11T23:11:22.583501864+01:00","updated_at":"2025-12-11T23:40:38.712293453+01:00","closed_at":"2025-12-11T23:40:38.712293453+01:00"}
{"id":"batchat-3x8.1","title":"Analysis: Map tview components to streaming architecture","description":"Document all tview components used in promptline and their mappings to streaming equivalents. Components found: TextView (chatView, header, progressIndicator), TextArea (inputArea), Table (permissionsTable), Flex (layout), Pages (modal management), Modal (quit/tool confirmations). Map to: pterm for output/styling, readline for input, AreaPrinter for fixed regions, zerolog for structured logging, tabwriter for tables.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:11:32.277566718+01:00","updated_at":"2025-12-11T23:25:50.864396804+01:00","closed_at":"2025-12-11T23:25:50.864396804+01:00","dependencies":[{"issue_id":"batchat-3x8.1","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:11:32.278479395+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.10","title":"Add structured logging with zerolog","description":"Integrate zerolog for operation history and debugging. Setup: 1) Initialize logger in main (output to stderr or file), 2) Log key events: user input, API requests, tool executions, errors, 3) Add structured fields: timestamp, user_input, model_response, tool_name, tool_args, tool_result, 4) Optional: --log-file flag to save session logs, 5) Debug mode (-d flag) sets log level to debug. Preserves complete operation history beyond scrollback.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:38.693171967+01:00","updated_at":"2025-12-11T23:29:54.756790166+01:00","closed_at":"2025-12-11T23:29:54.756790166+01:00","dependencies":[{"issue_id":"batchat-3x8.10","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:38.694026685+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.11","title":"Convert theme system to pterm/color styles","description":"Adapt internal/theme/theme.go from tcell colors to pterm/fatih/color. Theme fields map to: HeaderTextColor -\u003e pterm.FgCyan, ChatUserColor -\u003e color.FgBlue, ChatAssistantColor -\u003e color.FgGreen, ChatErrorColor -\u003e color.FgRed, etc. Update LoadTheme to parse theme.json and return pterm-compatible color objects. Alternative: simplify to use pterm defaults (Info/Success/Error/Warning) and remove theme.json dependency.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:46.350345096+01:00","updated_at":"2025-12-11T23:32:44.938618743+01:00","closed_at":"2025-12-11T23:32:44.938618743+01:00","dependencies":[{"issue_id":"batchat-3x8.11","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:46.351418399+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.12","title":"Optional: Add status area with AreaPrinter","description":"Consider adding fixed-position status area using pterm.DefaultArea for: connection status, model name, token count, current mode (processing/idle). Update in goroutine similar to old runProgressIndicator. This is optional - may not be needed if spinner suffices for feedback. Can be added post-MVP if users request persistent status display.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T23:12:53.825118525+01:00","updated_at":"2025-12-11T23:12:53.825118525+01:00","dependencies":[{"issue_id":"batchat-3x8.12","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:53.826096769+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.13","title":"Remove internal/ui package","description":"After all conversions complete, remove internal/ui/ui.go and internal/ui/history.go. Move History functionality to internal/session if still needed (readline has built-in history). Remove all tview imports from codebase. Update main.go to no longer import internal/ui package. Verify no dangling references.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:13:00.426436788+01:00","updated_at":"2025-12-11T23:38:57.843570162+01:00","closed_at":"2025-12-11T23:38:57.843570162+01:00","dependencies":[{"issue_id":"batchat-3x8.13","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:13:00.427365221+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.14","title":"Test streaming console implementation","description":"Comprehensive testing of new streaming architecture: 1) Manual testing: run interactive sessions, test all slash commands, verify tool permissions flow, test Ctrl+C cancellation, verify scrollback works, 2) Verify batch mode still works (no regressions), 3) Test over SSH to ensure portability, 4) Verify color output in different terminals, 5) Test readline history persistence, 6) Confirm graceful shutdown on signals. Document any behavioral changes in README.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:13:07.873230073+01:00","updated_at":"2025-12-11T23:39:35.162885048+01:00","closed_at":"2025-12-11T23:39:35.162885048+01:00","dependencies":[{"issue_id":"batchat-3x8.14","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:13:07.874175662+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.15","title":"Update documentation for streaming architecture","description":"Update all documentation to reflect streaming console instead of TUI: 1) README.md: change 'TUI' to 'interactive console', update keyboard shortcuts (Enter instead of Ctrl+Enter), mention scrollback capability, 2) QUICKSTART.md: update description and controls, 3) Add migration guide explaining differences from old TUI, 4) Update screenshot/demo if present, 5) Document new flags (--log-file, -d for debug). Emphasize advantages: scrollback, SSH-friendly, simpler UX.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:13:15.582500718+01:00","updated_at":"2025-12-11T23:40:32.807388409+01:00","closed_at":"2025-12-11T23:40:32.807388409+01:00","dependencies":[{"issue_id":"batchat-3x8.15","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:13:15.583786549+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.2","title":"Add new dependencies for streaming architecture","description":"Add required Go modules: github.com/pterm/pterm (CLI framework, colors, AreaPrinter), github.com/fatih/color (color/styling), github.com/rs/zerolog (structured logging). Note: readline and text/tabwriter already available. Update go.mod and go.sum. Remove tview dependency after migration complete.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:11:39.017143876+01:00","updated_at":"2025-12-11T23:28:45.207260426+01:00","closed_at":"2025-12-11T23:28:45.207260426+01:00","dependencies":[{"issue_id":"batchat-3x8.2","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:11:39.018340118+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.3","title":"Refactor main TUI loop to streaming event loop","description":"Replace tview.Application.Run() with readline-based event loop in cmd/promptline/main.go. Convert runTUIMode() from ui.Run() to: 1) Initialize readline with prompt, 2) Setup zerolog, 3) Main loop: read input -\u003e parse commands -\u003e process -\u003e output via pterm, 4) Handle Ctrl+C/Ctrl+Q gracefully, 5) Maintain command history via readline. Remove dependency on internal/ui package structure.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:11:46.342325052+01:00","updated_at":"2025-12-11T23:35:29.536599034+01:00","closed_at":"2025-12-11T23:35:29.536599034+01:00","dependencies":[{"issue_id":"batchat-3x8.3","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:11:46.343418135+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.4","title":"Convert chat display from TextView to streaming output","description":"Replace tview TextView (ui.chatView) with pterm streaming output. Convert handleConversation() to print directly to stdout using pterm.Info.Println() for messages. User messages: pterm styled output with color. Assistant messages: stream content chunks directly. Tool calls: format with pterm styling. Remove QueueUpdateDraw() calls. All chat history naturally available via terminal scrollback.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:11:53.697360002+01:00","updated_at":"2025-12-11T23:36:45.498643626+01:00","closed_at":"2025-12-11T23:36:45.498643626+01:00","dependencies":[{"issue_id":"batchat-3x8.4","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:11:53.698571678+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.5","title":"Convert progress indicator to pterm spinner","description":"Replace tview progress indicator (ui.progressIndicator, runProgressIndicator goroutine) with pterm.DefaultSpinner. Start spinner when processing begins, update text/status during tool calls, stop when complete. Use spinner.Start()/Stop() instead of QueueUpdateDraw(). Consider pterm.DefaultProgressbar for long operations.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:00.331997239+01:00","updated_at":"2025-12-11T23:36:52.005875246+01:00","closed_at":"2025-12-11T23:36:52.005875246+01:00","dependencies":[{"issue_id":"batchat-3x8.5","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:00.332929899+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.6","title":"Replace TextArea input with readline prompts","description":"Replace tview TextArea (ui.inputArea, setupInputHandlers) with readline.Readline() calls. Simplify from Ctrl+Enter submission to Enter submission (standard CLI behavior). Maintain Ctrl+Up/Down history navigation via readline built-in. Remove elastic height logic (runElasticHeight). Input prompts simply via rl.Readline(). Multi-line input can use readline.NewEx with custom handling if needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:09.566440645+01:00","updated_at":"2025-12-11T23:36:52.022877885+01:00","closed_at":"2025-12-11T23:36:52.022877885+01:00","dependencies":[{"issue_id":"batchat-3x8.6","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:09.567608832+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.7","title":"Convert permissions panel to interactive menu","description":"Replace tview Table-based permissions panel (ui.permissionsTable, buildPermissionsPanel) with: 1) /permissions command prints table via text/tabwriter + pterm styling, 2) Interactive toggle via pterm.DefaultInteractiveSelect or custom readline-based menu, 3) Permission changes save immediately, 4) Remove modal overlay/focus management. Alternative: print current state as table, prompt for tool name + toggle action.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:16.641913303+01:00","updated_at":"2025-12-11T23:38:00.576170062+01:00","closed_at":"2025-12-11T23:38:00.576170062+01:00","dependencies":[{"issue_id":"batchat-3x8.7","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:16.642900422+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.8","title":"Replace modals with readline prompts","description":"Convert tview Modal dialogs (showModalPrompt, showModalPromptAsync for quit confirm and tool permissions) to: 1) Print prompt text with pterm, 2) Use readline to read Y/N or numbered choice, 3) Validate input and act accordingly. Quit confirmation: simple Y/N prompt. Tool permission: display tool info, prompt Allow once/Always allow/Deny with numbered menu. Remove Pages-based modal management entirely.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:23.833986606+01:00","updated_at":"2025-12-11T23:38:07.447227122+01:00","closed_at":"2025-12-11T23:38:07.447227122+01:00","dependencies":[{"issue_id":"batchat-3x8.8","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:23.8352485+01:00","created_by":"daemon"}]}
{"id":"batchat-3x8.9","title":"Refactor slash commands for streaming output","description":"Update internal/commands/commands.go to work with streaming architecture. Remove tview dependencies (TextView, Application params). Commands should: 1) Accept session and logger, 2) Output via pterm (Info/Success/Error), 3) Return error instead of bool. Update handlers: /help, /clear, /history, /debug, /permissions, /quit. /history should print with pterm styling. /clear resets session only (no UI clear). /quit exits immediately.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T23:12:31.150259152+01:00","updated_at":"2025-12-11T23:38:13.045490049+01:00","closed_at":"2025-12-11T23:38:13.045490049+01:00","dependencies":[{"issue_id":"batchat-3x8.9","depends_on_id":"batchat-3x8","type":"parent-child","created_at":"2025-12-11T23:12:31.151199387+01:00","created_by":"daemon"}]}
{"id":"batchat-4vi","title":"Rebrand project to promptline","description":"Rebrand batchat to promptline across code, module name, binary, docs, config, and UI strings; update README to highlight dyne.org origin, Go TUI, OpenAI-compatible; ensure build/test/CI keep working under new name.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T13:21:35.223979842+01:00","updated_at":"2025-12-10T13:31:42.54361846+01:00","closed_at":"2025-12-10T13:31:42.54361846+01:00"}
{"id":"batchat-5gn","title":"Update Makefile build targets for new TUI implementation","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T15:31:29.267828737+01:00","updated_at":"2025-12-09T15:37:41.995898392+01:00","closed_at":"2025-12-09T15:37:41.995898392+01:00","dependencies":[{"issue_id":"batchat-5gn","depends_on_id":"batchat-g30","type":"blocks","created_at":"2025-12-09T15:32:01.382307343+01:00","created_by":"daemon"}],"comments":[{"id":1,"issue_id":"batchat-5gn","author":"jrml","text":"Update the Makefile to correctly build the application with the new TUI implementation. The build path needs to be updated to reflect the new main.go location in cmd/batchat/.","created_at":"2025-12-11T22:11:13Z"}]}
{"id":"batchat-5yg","title":"Tool call arguments dropped (ls path ignored)","description":"Asking the model to run ls with a specific path (e.g., '..') produces a tool call with empty arguments ({}), so the tool executes in the default directory instead of the requested path. This suggests the streamed tool_call arguments are being lost/overwritten before execution (cmd/promptline/main.go:596-657 tool execution, internal/chat/session.go stream accumulation/finalization). Investigate accumulation/formatting of tool_call arguments in streaming mode and ensure the exact JSON arguments from the provider are preserved through permission display and execution.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T15:54:49.709336727+01:00","updated_at":"2025-12-10T15:57:29.604801663+01:00","closed_at":"2025-12-10T15:57:29.604801663+01:00"}
{"id":"batchat-89r","title":"Permissions panel layout and toggles don’t meet requirements","description":"The /permissions view uses a plain table overlay that doesn’t meet the desired UX: it doesn’t consistently take at least half the right side of the screen, switches are rendered as static ON/OFF text instead of obvious toggles, and layout is horizontal/flat rather than a tall, polished vertical panel (see cmd/promptline/main.go:306-423). Build a tview-based panel that docks on the right at \u003e=50% width, stacks vertically with clear headers/footers, and uses a visible toggle control (checkbox/switch-like) that can be flipped on/off per tool.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T15:30:32.566355264+01:00","updated_at":"2025-12-12T12:12:39.434876294+01:00","closed_at":"2025-12-12T12:12:39.434876294+01:00"}
{"id":"batchat-8wa","title":"Honor API key env vars and validate config","description":"Config loader ignores OPENAI_API_KEY/DASHSCOPE_API_KEY even though docs promise env override; missing keys silently build an empty client (internal/config/config.go:28-54, README.md:34-64). Add env lookup with precedence over config file, fail fast when no key is provided, and handle provider-specific defaults for base_url/model. Update README/config.json.example and add unit tests covering env override and missing-key errors.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T11:58:02.005587078+01:00","updated_at":"2025-12-12T12:01:42.724775319+01:00","closed_at":"2025-12-12T12:01:42.724775319+01:00"}
{"id":"batchat-9bp","title":"Adopt TOON formatting for tool call results","description":"Use TOON (https://github.com/alpkeskin/gotoon) to format tool call results instead of plain text/JSON. Integrate gotoon where tool results are assembled (internal/chat/session.go AddToolResultMessage, cmd/batchat/main.go tool execution display, internal/tools/tools.go result formatting). Add a concise system-prompt snippet per https://toonformat.dev/guide/llm-prompts telling the LLM to expect/respond with TOON for tool outputs. Include tests covering TOON-formatted success/error payloads and ensure tool-call flows remain provider-compliant.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-10T12:42:08.012155465+01:00","updated_at":"2025-12-10T12:43:34.110991233+01:00"}
{"id":"batchat-b7g","title":"Replace ad-hoc tool markers with OpenAI tool/function-calling","description":"Tool handling relies on custom ✿FUNCTION✿ parsing and mutates user text, storing tool results as user messages instead of tool/function roles (cmd/batchat/main.go:285-352, internal/chat/session.go:321-346, internal/tools/tools.go:90-147). Adopt go-openai tool/function-calling so structured tool calls round-trip correctly, make Session.Messages thread-safe (mutex or channel ownership), and handle streaming tool output without losing prefix text. Add tests for multi-turn tool calls, history updates, and error surfaces.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:58:31.172468727+01:00","updated_at":"2025-12-10T12:16:32.731250087+01:00","closed_at":"2025-12-10T12:16:32.731250087+01:00"}
{"id":"batchat-bzi","title":"Fix tool-call response payloads and name handling","description":"Tool-calling flow returns tool role messages with raw text listings, which causes providers to reject with 400 invalid JSON for function.arguments/content; also saw empty tool names leading to 'unknown tool' execution (cmd/promptline/main.go tool handling; internal/chat/session.go AddToolResultMessage/stream accumulator). Ensure streamed tool calls always carry the function name and that tool result messages are JSON-encoded per function-calling contract (e.g., {\"result\": ...} or {\"error\": ...}). Add tests covering tool-call accumulation and JSON content formatting.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-10T12:20:45.174711563+01:00","updated_at":"2025-12-10T15:42:27.059993715+01:00","closed_at":"2025-12-10T15:42:27.059993715+01:00"}
{"id":"batchat-g30","title":"Implement TUI using tview for better user experience","description":"","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-09T15:29:59.864871865+01:00","updated_at":"2025-12-09T15:37:41.994679472+01:00","closed_at":"2025-12-09T15:37:41.994679472+01:00","comments":[{"id":2,"issue_id":"batchat-g30","author":"jrml","text":"Replace the current readline-based CLI interface with a terminal UI using the tview library. This will provide a more user-friendly interface with better visual organization of the chat history and input controls.","created_at":"2025-12-11T22:11:13Z"}]}
{"id":"batchat-k9o","title":"Update README.md to document TUI features","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T15:31:11.459289267+01:00","updated_at":"2025-12-09T15:37:41.997267505+01:00","closed_at":"2025-12-09T15:37:41.997267505+01:00","dependencies":[{"issue_id":"batchat-k9o","depends_on_id":"batchat-g30","type":"blocks","created_at":"2025-12-09T15:31:55.822232345+01:00","created_by":"daemon"}],"comments":[{"id":3,"issue_id":"batchat-k9o","author":"jrml","text":"Document the new TUI features including keyboard shortcuts (Ctrl+C to exit, Ctrl+G to generate code) and special commands (quit, exit, clear, history).","created_at":"2025-12-11T22:11:13Z"}]}
{"id":"batchat-ko9","title":"Refactor TUI into a testable UI/state package with clean teardown","description":"runTUIMode is ~500 lines mixing view construction, state, and goroutines that never stop (cmd/promptline/main.go:87-500). Extract a UI package/struct that owns the app, views, command registry, and history; give background goroutines (progress animation, elastic height) a context-driven shutdown tied to app.Stop; and centralize event handling/state updates so they can be unit/integration tested. Add tests for history navigation, input resizing, and processing cancellation to ensure lifecycle correctness.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T11:58:16.500824681+01:00","updated_at":"2025-12-10T16:22:17.956223866+01:00","closed_at":"2025-12-10T16:22:17.956223866+01:00"}
{"id":"batchat-ksm","title":"Evaluate migration to OpenAI Responses API","description":"Plan and track migrating from legacy Chat Completions to the new OpenAI Responses API (https://platform.openai.com/docs/guides/migrate-to-responses). Audit current prompt/tool-streaming paths, permissions, and TOON formatting; outline required client changes, request/response shape adjustments, and compatibility concerns. Propose a phased migration plan and identify any blockers or needed refactors in cmd/promptline/main.go and internal/chat/session.go.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-10T16:05:31.346150991+01:00","updated_at":"2025-12-10T16:05:31.346150991+01:00"}
{"id":"batchat-lfe","title":"Enable mouse scrolling in TextView","description":"Add mouse scrolling support for chat TextView by enabling app.EnableMouse(true) and ensuring TextView mouse handler/ScrollTo are wired. Verify wheel/keyboard scrolling both work when mouse is on, update any setup defaults/docs, and test to confirm mouse wheel navigates chat content.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-10T16:12:08.380616447+01:00","updated_at":"2025-12-10T16:12:16.647905192+01:00"}
{"id":"batchat-mui","title":"Prune legacy openbatch artifacts after promptline rebrand","description":"Remove or rewrite remnants of the old batch/openbatch workflow (e.g., example_batch_script.py, docs/openbatch.txt) so docs and samples match the promptline TUI chat focus.","status":"open","priority":3,"issue_type":"chore","created_at":"2025-12-10T13:32:05.200533972+01:00","updated_at":"2025-12-10T13:32:05.200533972+01:00"}
{"id":"batchat-ozi","title":"Code quality and maintainability improvements","description":"","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-12T09:01:15.027469009+01:00","updated_at":"2025-12-12T09:01:15.027469009+01:00"}
{"id":"batchat-ozi.1","title":"Remove duplicate readline initialization","description":"readline.NewEx is initialized twice: in cmd/promptline/main.go:167-177 and internal/chat/session.go:47-56. The session.go initialization creates unused RL field that's never used after NewSession(). Remove duplicate from session.go, pass readline instance from main if needed, or make it optional. Reduces initialization overhead and prevents conflicting configs.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:01:29.164707922+01:00","updated_at":"2025-12-12T09:50:08.483724346+01:00","closed_at":"2025-12-12T09:50:08.483724346+01:00","dependencies":[{"issue_id":"batchat-ozi.1","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:29.165668626+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.10","title":"Improve error handling consistency","description":"Error handling is inconsistent: some use log.Fatalf (batch mode), some panic (session.go:55), some return errors. Define error handling strategy: batch mode=exit codes, TUI mode=display errors, library code=return errors. Add custom error types for tool execution, API errors. Remove panics from library code. Add error recovery in streaming.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:06.785007001+01:00","updated_at":"2025-12-12T09:02:06.785007001+01:00","dependencies":[{"issue_id":"batchat-ozi.10","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:06.786092555+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.11","title":"Add input validation for shell commands","description":"execute_shell_command and write_file use sh -c without input sanitization (builtin.go:106-119, 136-154). Add validation: block command injection patterns, restrict file paths (no /etc, /sys), limit command length, timeout for long-running commands. Add allowlist/denylist config. Log all executed commands. Add tests for malicious inputs.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:02:06.804216634+01:00","updated_at":"2025-12-12T09:53:14.208641408+01:00","closed_at":"2025-12-12T09:53:14.208641408+01:00","dependencies":[{"issue_id":"batchat-ozi.11","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:06.805068384+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.12","title":"Implement graceful shutdown handling","description":"No graceful shutdown: Ctrl+C immediately terminates, losing unsaved history/state. Add signal handlers (SIGINT, SIGTERM), flush conversation history on shutdown, close OpenAI streams cleanly, save readline history. Add shutdown timeout. Test interrupted streaming, interrupted tool execution.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:06.823638474+01:00","updated_at":"2025-12-12T09:02:06.823638474+01:00","dependencies":[{"issue_id":"batchat-ozi.12","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:06.824728051+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.13","title":"Extract theme loading into dedicated package","description":"Theme loading in internal/theme is good but could be more modular: add theme validation, support multiple color schemes (light/dark), allow runtime theme switching, support NO_COLOR env var. Add theme.Manager to handle theme lifecycle. Current 91.7% coverage is good - maintain or improve.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T09:02:18.003498635+01:00","updated_at":"2025-12-12T09:02:18.003498635+01:00","dependencies":[{"issue_id":"batchat-ozi.13","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:18.004707149+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.14","title":"Add configuration validation and defaults","description":"Config loading silently uses defaults without warning. Add validation: check model availability, validate temperature/max_tokens ranges, warn on non-existent history file path, validate tool policy lists against registered tools. Add config.Validate() method. Config coverage is 88.9% - add edge case tests.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:18.023644984+01:00","updated_at":"2025-12-12T12:39:59.564978661+01:00","dependencies":[{"issue_id":"batchat-ozi.14","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:18.024747797+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.15","title":"Document potential race conditions","description":"Session.Messages protected by mutex but SaveConversationHistory reads without lock. Multiple goroutines access registry permissions. Review all shared state: Session.lastSavedMsgCount, toolCalls map in streaming, registry permissions. Add race detector to tests. Fix or document thread-safety guarantees.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:18.042275826+01:00","updated_at":"2025-12-12T09:02:18.042275826+01:00","dependencies":[{"issue_id":"batchat-ozi.15","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:18.04311049+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.16","title":"Simplify streaming API and event types","description":"StreamEvent has 3 types but could be cleaner: consider Result[content|toolCall|error] pattern or separate channels. StreamResponseWithContext mixes channel closing with event sending. Consider: separate content/tool/error channels, or unified Result type with discriminated union. Improve API ergonomics for callers.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:29.923734034+01:00","updated_at":"2025-12-12T09:02:29.923734034+01:00","dependencies":[{"issue_id":"batchat-ozi.16","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:29.924949463+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.17","title":"Add dependency injection for testability","description":"main.go directly instantiates OpenAI client, session, readline - hard to test. Extract interfaces: ChatClient, HistoryStorage, InputReader. Use constructor injection. Add mock implementations for testing. This enables unit testing of TUI logic without real API calls or terminal.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T09:02:29.944502609+01:00","updated_at":"2025-12-12T09:02:29.944502609+01:00","dependencies":[{"issue_id":"batchat-ozi.17","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:29.945676936+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.18","title":"Create tool execution middleware pattern","description":"Tool execution is monolithic: permission check → execute → format. Add middleware pattern: logging middleware, timing middleware, retry middleware, rate limiting. Allows pluggable cross-cutting concerns. Define ToolMiddleware interface, chain in registry. Add examples: audit log, metrics collection.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T09:02:29.963923671+01:00","updated_at":"2025-12-12T09:02:29.963923671+01:00","dependencies":[{"issue_id":"batchat-ozi.18","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:29.96506786+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.19","title":"Add comprehensive documentation","description":"Add godoc comments to all exported types/functions (especially session.go, tools.go). Create docs/ARCHITECTURE.md explaining package relationships, data flow, streaming model. Add docs/TESTING.md with testing strategy. Document tool permission model. Add examples/ directory with sample configs and tool implementations.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T09:02:39.693666176+01:00","updated_at":"2025-12-12T09:02:39.693666176+01:00","dependencies":[{"issue_id":"batchat-ozi.19","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:39.694429571+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.2","title":"Extract main.go into smaller modules","description":"main.go is 551 lines with multiple responsibilities: CLI setup, TUI mode, batch mode, command handling, streaming, tool execution, history search (runTUIMode has cyclomatic complexity 16). Split into: cmd/promptline/batch.go, cmd/promptline/tui.go, cmd/promptline/commands.go, cmd/promptline/streaming.go. Keep main.go as entry point only. Improves testability and readability.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:01:29.183751551+01:00","updated_at":"2025-12-12T10:43:09.467279031+01:00","closed_at":"2025-12-12T10:43:09.467279031+01:00","dependencies":[{"issue_id":"batchat-ozi.2","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:29.18459809+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.20","title":"Performance optimization review","description":"Profile CPU/memory usage during streaming. Optimize: reduce string allocations in streaming (use strings.Builder consistently), optimize tool call accumulation (reuse builders), reduce mutex contention in registry. Add benchmarks: streaming throughput, tool execution overhead, history save/load. Target: \u003c10ms tool execution latency.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T09:02:39.709179111+01:00","updated_at":"2025-12-12T09:02:39.709179111+01:00","dependencies":[{"issue_id":"batchat-ozi.20","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:02:39.70990405+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.3","title":"Reduce complexity of listDirectory function","description":"listDirectory in internal/tools/builtin.go:156-241 has cyclomatic complexity 20 with nested conditionals for recursive/non-recursive paths, hidden files, and error handling. Extract helper functions: walkDirectory(), formatDirectoryEntry(), filterHiddenFiles(). Add table-driven tests for different scenarios. Target complexity \u003c10.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T09:01:29.201606381+01:00","updated_at":"2025-12-12T12:26:50.236603486+01:00","closed_at":"2025-12-12T12:26:50.236603486+01:00","dependencies":[{"issue_id":"batchat-ozi.3","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:29.202468503+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.4","title":"Refactor StreamResponseWithContext complexity","description":"StreamResponseWithContext in internal/chat/session.go:214-290 has cyclomatic complexity 15 with complex nested select/for loops, tool call accumulation, and error handling. Extract helpers: handleStreamChunk(), accumulateToolCall(), finalizeResponse(). Simplify control flow and add unit tests for different streaming scenarios.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T09:01:40.949907591+01:00","updated_at":"2025-12-12T12:39:41.628422695+01:00","closed_at":"2025-12-12T12:39:41.628422695+01:00","dependencies":[{"issue_id":"batchat-ozi.4","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:40.950858092+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.5","title":"Consolidate tool result formatting","description":"Tool result formatting is duplicated: executeToolCall() in main.go:512-551 and FormatToolCallDisplay() in session.go:579-607. Both truncate results, format args, show errors. Create single tools.FormatToolResult() function in tools package. Use consistent formatting across batch/TUI modes.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T09:01:40.969357378+01:00","updated_at":"2025-12-12T10:51:11.238703977+01:00","closed_at":"2025-12-12T10:51:11.238703977+01:00","dependencies":[{"issue_id":"batchat-ozi.5","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:40.970245357+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.6","title":"Remove unused Session fields and methods","description":"Session struct has unused/redundant fields: Scanner (never used after initialization), RL (duplicate of main's readline), history []string (readline handles this). GeneratePythonCode method appears legacy/unused. Clean up unused fields, remove dead code, simplify NewSession(). Verify no dependencies before removal.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T09:01:40.984080621+01:00","updated_at":"2025-12-12T09:01:40.984080621+01:00","dependencies":[{"issue_id":"batchat-ozi.6","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:40.985084264+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.7","title":"Increase coverage for internal/chat package","description":"internal/chat coverage is 27.9%. Missing tests for: LoadConversationHistory/SaveConversationHistory edge cases (maxLines, corrupted JSON, concurrent access), streaming event channels, context cancellation, tool call accumulation/finalization. Add table-driven tests for message history management, streaming scenarios, error paths. Target 70%+ coverage.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:01:53.260349539+01:00","updated_at":"2025-12-12T11:23:26.199136538+01:00","closed_at":"2025-12-12T11:23:26.199136538+01:00","dependencies":[{"issue_id":"batchat-ozi.7","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:53.261563703+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.8","title":"Add integration tests for main.go","description":"cmd/promptline/main.go has 0% coverage. Add integration tests: batch mode (stdin/stdout), command handling (/help, /clear, /history, /permissions), streaming conversation flow, tool execution flow, Ctrl+R history search. Use testable interfaces or extract testable functions. Mock OpenAI client. Target 50%+ coverage.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T09:01:53.280862254+01:00","updated_at":"2025-12-12T11:37:32.145065495+01:00","closed_at":"2025-12-12T11:37:32.145065495+01:00","dependencies":[{"issue_id":"batchat-ozi.8","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:53.282174898+01:00","created_by":"daemon"}]}
{"id":"batchat-ozi.9","title":"Add error handling tests for tools package","description":"tools package at 82.5% - add tests for: permission denied scenarios, tool not found errors, invalid JSON arguments, concurrent tool execution, policy application edge cases. Test ExecuteWithOptions Force flag, confirmation requirements. Add benchmarks for tool registry operations. Target 90%+ coverage.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T09:01:53.299238747+01:00","updated_at":"2025-12-12T12:17:33.974993216+01:00","closed_at":"2025-12-12T12:17:33.974993216+01:00","dependencies":[{"issue_id":"batchat-ozi.9","depends_on_id":"batchat-ozi","type":"parent-child","created_at":"2025-12-12T09:01:53.300120531+01:00","created_by":"daemon"}]}
{"id":"batchat-pf9","title":"Permissions modal freezes during tool confirmation","description":"Permission prompts (/permissions modal shown for tool calls) occasionally freeze the TUI: the modal appears but won’t accept input, leaving the app stuck until force-quit. Reproduce by running a tool call that requires confirmation; the modal grabs focus but buttons/keys don’t dismiss. Ensure permission dialogs always stay responsive (focus, ESC/cancel path), clean up pages/focus after close, and add regression coverage if possible.","status":"in_progress","priority":1,"issue_type":"bug","created_at":"2025-12-10T16:29:25.061494716+01:00","updated_at":"2025-12-10T16:40:12.923143361+01:00","dependencies":[{"issue_id":"batchat-pf9","depends_on_id":"batchat-3vx","type":"discovered-from","created_at":"2025-12-10T16:29:25.067458535+01:00","created_by":"jrml"}]}
{"id":"batchat-pfi","title":"Add readline library dependency for enhanced CLI input handling","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-09T14:29:11.221094923+01:00","updated_at":"2025-12-09T14:34:11.297333661+01:00","closed_at":"2025-12-09T14:34:11.297333661+01:00","dependencies":[{"issue_id":"batchat-pfi","depends_on_id":"batchat-2ey","type":"discovered-from","created_at":"2025-12-09T14:29:11.221924027+01:00","created_by":"daemon"}]}
{"id":"batchat-ttl","title":"Add chat streaming/tool-call coverage","description":"Add unit tests in internal/chat for streaming/tool-call flow: chunked tool_call deltas merge into final calls with arguments and fallback name; tool errors still emit tool messages; TOON formatting includes result and error fields. Mock tool execution to force success and error paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T13:03:34.092020622+01:00","updated_at":"2025-12-10T13:05:31.788248629+01:00","closed_at":"2025-12-10T13:05:31.788248629+01:00"}
{"id":"batchat-ued","title":"Add command handlers unit tests","description":"Add tests for internal/commands: /help uses existing registry (no hardcoded list), /clear preserves only the system message, /history renders tool messages as 'Tool', /debug toggles flag and shows system prompt. Exercise handlers with fake chat session/messages and ensure no panics.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-10T13:03:19.844856861+01:00","updated_at":"2025-12-10T13:03:19.844856861+01:00"}
{"id":"batchat-ukh","title":"Fix command registry help output and drop /generate stub","description":"The /help handler rebuilds a brand-new registry and hardcodes the command list, so any future commands/extensions are invisible; /generate is a stub we want removed, and commands lack tests (internal/commands/commands.go:126-151, 131-139). Reuse the existing registry for help output, inject dependencies into command handlers, and drop /generate until we intentionally add it later. Add unit tests for help/history/clear behavior and run gofmt over internal/tools/tools_test.go to keep tests readable.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-10T11:58:45.773229018+01:00","updated_at":"2025-12-10T12:01:51.506817082+01:00"}
